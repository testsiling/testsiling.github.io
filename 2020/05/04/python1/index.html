<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>Closure and Decorator in Python</title><link rel="stylesheet" href="/css/normalize.css"><link rel="stylesheet" href="/css/hexo-theme-adoubi.css"><link rel="icon" href="/images/favicon.ico"><meta name="generator" content="Hexo 5.2.0"></head><body><div class="header"><a class="github-link" target="_blank" rel="noopener" href="https://github.com/testsiling"><img class="github-image" src="/images/Aquicon-Github-small.png"></a><a class="linkedin-link" target="_blank" rel="noopener" href="https://www.linkedin.com/in/silingchen0"><img class="linkedin-image" src="/images/linkedin.png"></a><a class="email-link" href="mailto:testsiling@gmail.com"><img class="email-image" src="/images/email-small.png"></a></div><div class="content"><div class="post-item"></div><h2 class="post-title-wrapper"><p class="post-title">Closure and Decorator in Python</p></h2><div class="post-date"><time datetime="2020-05-05T02:48:44.000Z">2020-05-04</time></div><div class="post-content"><h1 id="Closure"><a href="#Closure" class="headerlink" title="Closure"></a>Closure</h1><p>function wraps function. When you want to save state of a function but don’t want to write a decent class, use closure.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new_counter</span>():</span></span><br><span class="line">    total = <span class="number">0</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">count</span>():</span></span><br><span class="line">		<span class="keyword">nonlocal</span> total</span><br><span class="line">		total += <span class="number">1</span></span><br><span class="line">		<span class="keyword">return</span> total</span><br><span class="line">	<span class="keyword">return</span> count</span><br></pre></td></tr></table></figure>

<p>then you can use it to count student amount of different classes:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">math = new_counter()</span><br><span class="line">tennis = new_counter()</span><br><span class="line"></span><br><span class="line">math(), math(), math(), math(), math(), math()</span><br><span class="line">tennis(), tennis()</span><br></pre></td></tr></table></figure>

<p>When closure search a variables, Local -&gt; enclosing -&gt; global -&gt; builtin.<br>In the example, <code>total</code> stores in enclosing level.</p>
<h1 id="Decorator"><a href="#Decorator" class="headerlink" title="Decorator"></a>Decorator</h1><p>Decorator wraps a closure with extra function, but won’t change the inner function, it returns a closure.<br>Example, logger</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_logger</span>(<span class="params">func</span>):</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">		print(<span class="string">f&quot;calling <span class="subst">&#123;func.__name__&#125;</span>&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">	<span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@my_logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_total</span>(<span class="params">ls</span>):</span></span><br><span class="line">	<span class="keyword">return</span> sum(ls)</span><br><span class="line"></span><br><span class="line">ls = [<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>]</span><br><span class="line">get_total(ls)</span><br><span class="line"><span class="comment"># calling get_total</span></span><br><span class="line"><span class="comment"># 45</span></span><br></pre></td></tr></table></figure>

<p>But decorated function’s function will become pretty confused about its identity. <code>get_total.__name__</code> will return <code>&#39;wrapper&#39;</code>.<br>Use <code>@functools.wraps</code> to preserve original function info.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> functools</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">my_logger</span>(<span class="params">func</span>):</span></span><br><span class="line"><span class="meta">	@functools.wraps(func)</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">		print(<span class="string">f&quot;calling <span class="subst">&#123;func.__name__&#125;</span>&quot;</span>)</span><br><span class="line">		<span class="keyword">return</span> func(*args, **kwargs)</span><br><span class="line">	<span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@my_logger</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_total</span>(<span class="params">ls</span>):</span></span><br><span class="line">	<span class="keyword">return</span> sum(ls)</span><br><span class="line"></span><br><span class="line">get_total.__name__  <span class="comment"># &#x27;get_total&#x27;</span></span><br></pre></td></tr></table></figure>



<h3 id="Implement-Singleton-by-Decorator"><a href="#Implement-Singleton-by-Decorator" class="headerlink" title="Implement Singleton by Decorator"></a>Implement Singleton by Decorator</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">singleton</span>(<span class="params">cls</span>):</span></span><br><span class="line">    instances = &#123;&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span>(<span class="params">*args, **kwargs</span>):</span></span><br><span class="line">        <span class="keyword">if</span> cls <span class="keyword">not</span> <span class="keyword">in</span> instances:</span><br><span class="line">          instances[cls] = cls(*args, **kwargs)</span><br><span class="line">        <span class="keyword">return</span> instances[cls]</span><br><span class="line">    <span class="keyword">return</span> wrapper</span><br><span class="line"></span><br><span class="line"><span class="meta">@singleton</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>:</span></span><br><span class="line">	<span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, name</span>):</span></span><br><span class="line">		self.name = name</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">submit</span>(<span class="params">self</span>):</span></span><br><span class="line">        <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;self.name&#125;</span> Submitted!!!&quot;</span></span><br><span class="line"></span><br><span class="line">c1 = MyClass(<span class="string">&#x27;hello&#x27;</span>)</span><br><span class="line">c2 = MyClass(<span class="string">&#x27;world&#x27;</span>)</span><br><span class="line"></span><br><span class="line">c1 == c2  <span class="comment"># True</span></span><br><span class="line">c1.name, c2.name  <span class="comment"># &#x27;hello&#x27;, &#x27;hello&#x27;</span></span><br></pre></td></tr></table></figure>



<p><em>So the next step, is refactor my reporting and logging modules in the next sprint.</em></p>
</div></div><div class="footer"><div class="footer-copyright">Theme By <a target="_blank" rel="noopener" href="https://github.com/shinux/hexo-theme-adoubi">Adoubi</a> , Powered By Hexo.</div></div></body></html>